!function(){var n,r,a;function c(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}n=function(t,n){return null==n&&(n=[]),function(){return 2===n.s?Promise.resolve():1===n.s?new Promise(function(t,e){return n.push({res:t,rej:e})}):Promise.resolve(n.s=1).then(function(){return t()}).then(function(){return n.s=2,n.splice(0).map(function(t){return t.res()})}).catch(function(e){return n.s=0,n.splice(0).map(function(t){return t.rej(e)}),Promise.reject(e)})}},r={"zh-TW":{Category:"分類",Subset:"子集",Name:"名稱","Use Your Own Font":"上傳",or:"或",Cancel:"取消"}},(a=function(t){var e=this;return this.opt=t=null==t?{}:t,this._url={meta:t.meta,links:t.links},this._metadata=t.metadata,["meta","links"].map(function(t){if(!e._url[t]&&a._url[t])return e._url[t]=a._url[t]}),this.root="string"==typeof t.root?document.querySelector(t.root):t.root,this._initRender=null!=t.initRender&&t.initRender,this.evtHandler={},this.root&&(this.ldld=new ldloader({container:this.root,autoZ:!0,className:"ldld full"})),this.i18n=t.i18n||{t:function(t){return t}},this.init=n(function(){return e._init()}),this}).url=function(t){return null==t&&(t={}),arguments.length?c(a._url||(a._url={}),t):a._url||{}},a.prototype=c(Object.create(Object.prototype),{on:function(t,n){var r=this;return(Array.isArray(t)?t:[t]).map(function(t){var e;return((e=r.evtHandler)[t]||(e[t]=[])).push(n)})},fire:function(t){for(var e,n,r,o,i=[],a=[],l=1,u=arguments.length;l<u;++l)a.push(arguments[l]);for(e=a,l=0,r=(n=this.evtHandler[t]||[]).length;l<r;++l)o=n[l],i.push(o.apply(this,e));return i},metadata:function(t){return arguments.length?this._metadata=JSON.parse(JSON.stringify(t)):this._metadata},config:function(e){var n=this;return null==e&&(e={}),["state","upload","order"].forEach(function(t){if(null!=e[t])return n.opt[t]=e[t]}),this.init().then(function(){return e.order&&n.meta&&n.meta.family.sort(n.opt.order),n.render()})},load:function(r){var o=this,i=null;return this.init().then(function(){var t,e,n;return r?(a._customFont||(a._customFont={}))[r.name]?a._customFont[r.name]:r.mod&&r.mod.file&&r.mod.file.blob?o.fontFromFile({file:r.mod.file,name:r.name}):(t="number"==typeof r?o.meta.family[r]:"string"==typeof r?o.meta.family.filter(function(t){return t.n.toLowerCase()===r.toLowerCase()})[0]:r.name?o.meta.family.filter(function(t){return t.n.toLowerCase()===r.name.toLowerCase()})[0]:r)?(n=(i=t.fonts[0]).xfont)?Promise.resolve(n):(n=o.meta.index.style[i.s],e=o.meta.index.weight[i.w],n=o._url.links+"/"+t.n+"/"+n+"/"+e+(i.x?"":".ttf"),xfl.load({path:n,name:t.n}).then(function(t){return(t.mod||(t.mod={})).limited=o._limited({font:r}),t})):Promise.reject(((e=new Error).message="font not found",e.id=404,e)):null}).then(function(t){return i&&(i.xfont=t),t})},_limited:function(t){var e,n=t.font,t=t.isUpload,r=!!n&&(e=(n.n||n.name).toLowerCase(),this.meta.family.filter(function(t){return t.n.toLowerCase()===e})[0]),t=t||!r?"upload":"state",r=!("function"!=typeof this.opt[t]||!this.opt[t]({font:n,type:"limited"}));return n&&((n.mod||(n.mod={})).limited=r),r},render:function(){var n,t=this;return this.ldld.on(),n=function(){return t.init().then(function(){return t.view.render(),t.ldld.off(),t._rendered=!0})},this._rendered?n():new Promise(function(e,t){return setTimeout(function(){return n().then(function(t){return e(t)})},50)})},fontFromFile:function(t){var e,n,r,o=this,i=t.file,t=t.name;return this.ldld.on(),t=t||"custom-"+(parseInt(Math.random()*Date.now())+Date.now()).toString(36),r=URL.createObjectURL(i.blob||i),e=(e=/(ttf|otf|woff2|woff)$/.exec(i.type||""))?e[1]:"ttf",(a._customFont||(a._customFont={}))[t]=n=new xfl.xlfont({path:r,name:t,isXl:!1,ext:e}),xfl.track(n),(n.mod||(n.mod={})).file=((r={lastModified:i.lastModified,name:i.name,size:i.size,type:i.type}).blob=i.blob||i,r),this._limited({font:n,isUpload:!0}),n.init().finally(function(){return o.fire("load.end"),o.ldld.off()}).then(function(){return o.fire("choose",n)}).then(function(){return n}).catch(function(t){return console.error("[@xlfont/choose] font load failed: ",t),o.fire("load.fail",t),null})},_init:function(){var f=this;if(!this.meta)return new Promise(function(t,e){var n;return f._metadata?t(f._metadata):((n=new XMLHttpRequest).addEventListener("readystatechange",function(){if(4===n.readyState){if(200!==n.status)return e(n.responseText);try{return t(JSON.parse(n.responseText))}catch(t){return e(t)}}}),n.open("GET",f._url.meta+"/meta.json"),n.onerror=function(t){return e(t)},n.send())}).then(function(t){var e,n;if(f.meta=t,f.meta.family.forEach(function(t,e){return t.i=e}),f.meta.family=f.meta.family.filter(function(t){return t.n}),f.opt.order&&f.meta.family.sort(f.opt.order),f.root){if(f.cfg={},f.i18n.addResourceBundle){for(e in n=r)f.i18n.addResourceBundle(e,"@plotdb/choose",n[e],!0,!0);Array.from(f.root.querySelectorAll("[t]")).map(function(t){return t.textContent=f.i18n.t("@plotdb/choose:"+t.textContent)})}return f.view=new ldview({initRender:f._initRender,root:f.root,action:{input:{search:function(t){t=t.node;return f.cfg.keyword=t.value||"",f.view.render(["font"])}},click:{cancel:function(){return f.fire("choose",null)}},change:{upload:function(t){var t=t.node,e=t.files?t.files[0]:null;if(t.value="",e)return f.fontFromFile({file:e,name:e.name?e.name+" from Upload":null})}}},init:{"cur-subset":function(t){t=t.node;if("undefined"!=typeof BSN&&null!==BSN)return new BSN.Dropdown(t)},"cur-cat":function(t){t=t.node;if("undefined"!=typeof BSN&&null!==BSN)return new BSN.Dropdown(t)}},handler:{"upload-button":function(t){return t.node.classList.toggle("limited",!!f._limited({isUpload:!0}))},"cur-subset":function(t){t=t.node;return t.textContent=f.cfg.subset||"all",t.classList.toggle("active",!(!f.cfg.subset||"all"===f.cfg.subset))},"cur-cat":function(t){t=t.node;return t.textContent=f.cfg.category||"all",t.classList.toggle("active",!(!f.cfg.category||"all"===f.cfg.category))},category:{list:function(){return["all"].concat(f.meta.index.category)},action:{click:function(t){t.node;t=t.data;return f.cfg.category=t,f.view.render(["font","cur-cat","category"])}},handler:function(t){var e=t.node,t=t.data;return e.textContent=t,e.classList.toggle("active",f.cfg.category===t||!f.cfg.category&&"all"===t)}},subset:{list:function(){return["all"].concat(f.meta.index.subset)},action:{click:function(t){t.node;t=t.data;return f.cfg.subset=t,f.view.render(["font","cur-subset","subset"])}},handler:function(t){var e=t.node,t=t.data;return e.textContent=t,e.classList.toggle("active",f.cfg.subset===t||!f.cfg.subset&&"all"===t)}},"font-list":function(t){var t=t.node,e=f.meta.dim.width;return t.style.gridTemplateColumns="repeat(auto-fill,"+e+"px)"},font:{list:function(){return f.meta.family},host:"undefined"!=typeof vscroll&&null!==vscroll?vscroll.fixed:void 0,key:function(t){return t.n},action:{click:function(t){t.node;t=t.data;return f.ldld.on(),f.fire("load.start"),f.load(t).finally(function(){return f.fire("load.end"),f.ldld.off()}).then(function(t){return f.fire("choose",t)}).catch(function(t){return console.error("[@xlfont/choose] font load failed: ",t),f.fire("load.fail",t)})}},handler:function(t){var e=t.node,t=t.data,n=[f.cfg.keyword,f.cfg.category,f.cfg.subset,f.meta.index],r=n[0],o=n[1],i=n[2],n=n[3];return e.classList.toggle("limited",f._limited({font:t})),e.classList.toggle("d-none",!t.n||r&&!~(""+t.n+t.d).toLowerCase().indexOf(r.toLowerCase())||!(!o||"all"===o||n.category.indexOf(o)===t.c)||!(!i||"all"===i||function(t,e){var n=-1,r=e.length>>>0;for(;++n<r;)if(t===e[n])return 1;return}(n.subset.indexOf(i),t.s)))},init:function(t){var e=t.node,t=t.data,n=t.i,r=n%f.meta.dim.col,n=Math.floor(n/f.meta.dim.col),o=f.meta.dim.padding,i=f.meta.dim.width,a=f.meta.dim.height,l=e.querySelector("[ld=name]"),u=e.querySelector("[ld=preview]");return e.style,c(u.style,{width:i+"px",height:a+"px",backgroundImage:"url("+f._url.meta+"/sprite.min.png)",backgroundPosition:-(i+o)*r+"px "+-(a+o)*n+"px"}),l.textContent=t.n}}}})}})}}),"undefined"!=typeof module&&null!==module?module.exports=a:"undefined"!=typeof window&&null!==window&&(window.xfc=a)}.call(this);
