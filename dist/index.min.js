!function(){var n,r,u;function f(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}function l(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return 1}n=function(t,n){return null==n&&(n=[]),function(){return 2===n.s?Promise.resolve():1===n.s?new Promise(function(t,e){return n.push({res:t,rej:e})}):Promise.resolve(n.s=1).then(function(){return t()}).then(function(){return n.s=2,n.splice(0).map(function(t){return t.res()})}).catch(function(e){return n.s=0,n.splice(0).map(function(t){return t.rej(e)}),Promise.reject(e)})}},r={"zh-TW":{Category:"分類",Subset:"子集",Name:"名稱","Use Your Own Font":"上傳",or:"或",Cancel:"取消"}},(u=function(t){var e=this;return this.opt=t=null==t?{}:t,this._url={meta:t.meta,links:t.links},["meta","links"].map(function(t){if(!e._url[t]&&u._url[t])return e._url[t]=u._url[t]}),this.root="string"==typeof t.root?document.querySelector(t.root):t.root,this._initRender=null!=t.initRender&&t.initRender,this.evtHandler={},this.root&&(this.ldld=new ldloader({container:this.root,autoZ:!0,className:"ldld full"})),this.i18n=t.i18n||{t:function(t){return t}},this.init=n(function(){return e._init()}),this}).url=function(t){return null==t&&(t={}),arguments.length?f(u._url||(u._url={}),t):u._url||{}},u.prototype=f(Object.create(Object.prototype),{on:function(t,n){var r=this;return(Array.isArray(t)?t:[t]).map(function(t){var e;return((e=r.evtHandler)[t]||(e[t]=[])).push(n)})},fire:function(t){for(var e,n,r,o,i=[],u=[],l=1,a=arguments.length;l<a;++l)u.push(arguments[l]);for(e=u,l=0,r=(n=this.evtHandler[t]||[]).length;l<r;++l)o=n[l],i.push(o.apply(this,e));return i},config:function(e){var n=this;return null==e&&(e={}),["state","upload","order"].forEach(function(t){if(null!=e[t])return n.opt[t]=e[t]}),this.init().then(function(){return e.order&&n.meta&&n.meta.family.sort(n.opt.order),n.render()})},load:function(o){var i=this;return this.init().then(function(){var t,e,n,r;return o?(u._customFont||(u._customFont={}))[o.name]?u._customFont[o.name]:(t="number"==typeof o?i.meta.family[o]:"string"==typeof o?i.meta.family.filter(function(t){return t.n.toLowerCase()===o.toLowerCase()})[0]:o.name?i.meta.family.filter(function(t){return t.n.toLowerCase()===o.name.toLowerCase()})[0]:o)?(r=(e=t.fonts[0]).xfont)?Promise.resolve(r):(r=i.meta.index.style[e.s],n=i.meta.index.weight[e.w],r=i._url.links+"/"+t.n+"/"+r+"/"+n+(e.x?"":".ttf"),xfl.load({path:r,name:t.n}).then(function(t){return t.limited=i._limited({font:o}),e.xfont=t})):Promise.reject(((n=new Error).message="font not found",n.id=404,n)):null})},_limited:function(t){var e=t.font,t=t.isUpload||!l(e,this.meta.family)?"upload":"state",t=!("function"!=typeof this.opt[t]||!this.opt[t]({font:e,type:"limited"}));return e&&(e.limited=t),t},render:function(){var n,t=this;return this.ldld.on(),n=function(){return t.init().then(function(){return t.view.render(),t.ldld.off(),t._rendered=!0})},this._rendered?n():new Promise(function(e,t){return setTimeout(function(){return n().then(function(t){return e(t)})},50)})},_init:function(){var c=this;return new Promise(function(t,e){var n=new XMLHttpRequest;return n.addEventListener("readystatechange",function(){if(4===n.readyState){if(200!==n.status)return e(n.responseText);try{c.meta=JSON.parse(n.responseText),c.meta.family.forEach(function(t,e){return t.i=e}),c.meta.family=c.meta.family.filter(function(t){return t.n}),c.opt.order&&c.meta.family.sort(c.opt.order)}catch(t){return e(t)}return t()}}),n.open("GET",c._url.meta+"/meta.json"),n.onerror=function(t){return e(t)},n.send()}).then(function(){var t,e;if(c.root){if(c.cfg={},c.i18n.addResourceBundle){for(t in e=r)c.i18n.addResourceBundle(t,"@plotdb/choose",e[t],!0,!0);Array.from(c.root.querySelectorAll("[t]")).map(function(t){return t.textContent=c.i18n.t("@plotdb/choose:"+t.textContent)})}return c.view=new ldview({initRender:c._initRender,root:c.root,action:{input:{search:function(t){t=t.node;return c.cfg.keyword=t.value||"",c.view.render(["font"])}},click:{cancel:function(){return c.fire("choose",null)}},change:{upload:function(t){var e,n,r=t.node,t=r.files?r.files[0]:null;return t?(c.ldld.on(),e="custom-"+(parseInt(Math.random()*Date.now())+Date.now()).toString(36),t=URL.createObjectURL(t),(u._customFont||(u._customFont={}))[e]=n=new xfl.xlfont({path:t,name:e,isXl:!1}),c._limited({font:n,upload:!0}),n.init().finally(function(){return r.value="",c.fire("load.end"),c.ldld.off()}).then(function(){return c.fire("choose",n)}).catch(function(t){return console.error("[@xlfont/choose] font load failed: ",t),c.fire("load.fail",t)})):r.value=""}}},init:{"cur-subset":function(t){t=t.node;if("undefined"!=typeof BSN&&null!==BSN)return new BSN.Dropdown(t)},"cur-cat":function(t){t=t.node;if("undefined"!=typeof BSN&&null!==BSN)return new BSN.Dropdown(t)}},handler:{"upload-button":function(t){return t.node.classList.toggle("limited",!!c._limited({isUpload:!0}))},"cur-subset":function(t){t=t.node;return t.textContent=c.cfg.subset||"all",t.classList.toggle("active",!(!c.cfg.subset||"all"===c.cfg.subset))},"cur-cat":function(t){t=t.node;return t.textContent=c.cfg.category||"all",t.classList.toggle("active",!(!c.cfg.category||"all"===c.cfg.category))},category:{list:function(){return["all"].concat(c.meta.index.category)},action:{click:function(t){t.node;t=t.data;return c.cfg.category=t,c.view.render(["font","cur-cat","category"])}},handler:function(t){var e=t.node,t=t.data;return e.textContent=t,e.classList.toggle("active",c.cfg.category===t||!c.cfg.category&&"all"===t)}},subset:{list:function(){return["all"].concat(c.meta.index.subset)},action:{click:function(t){t.node;t=t.data;return c.cfg.subset=t,c.view.render(["font","cur-subset","subset"])}},handler:function(t){var e=t.node,t=t.data;return e.textContent=t,e.classList.toggle("active",c.cfg.subset===t||!c.cfg.subset&&"all"===t)}},"font-list":function(t){var t=t.node,e=c.meta.dim.width;return t.style.gridTemplateColumns="repeat(auto-fill,"+e+"px)"},font:{list:function(){return c.meta.family},host:"undefined"!=typeof vscroll&&null!==vscroll?vscroll.fixed:void 0,key:function(t){return t.n},action:{click:function(t){t.node;t=t.data;return c.ldld.on(),c.fire("load.start"),c.load(t).finally(function(){return c.fire("load.end"),c.ldld.off()}).then(function(t){return c.fire("choose",t)}).catch(function(t){return console.error("[@xlfont/choose] font load failed: ",t),c.fire("load.fail",t)})}},handler:function(t){var e=t.node,t=t.data,n=[c.cfg.keyword,c.cfg.category,c.cfg.subset,c.meta.index],r=n[0],o=n[1],i=n[2],n=n[3];return e.classList.toggle("limited",c._limited({font:t})),e.classList.toggle("d-none",!t.n||r&&!~(""+t.n+t.d).toLowerCase().indexOf(r.toLowerCase())||!(!o||"all"===o||n.category.indexOf(o)===t.c)||!(!i||"all"===i||l(n.subset.indexOf(i),t.s)))},init:function(t){var e=t.node,t=t.data,n=t.i,r=n%c.meta.dim.col,n=Math.floor(n/c.meta.dim.col),o=c.meta.dim.padding,i=c.meta.dim.width,u=c.meta.dim.height,l=e.querySelector("[ld=name]"),a=e.querySelector("[ld=preview]");return e.style,f(a.style,{width:i+"px",height:u+"px",backgroundImage:"url("+c._url.meta+"/sprite.min.png)",backgroundPosition:-(i+o)*r+"px "+-(u+o)*n+"px"}),l.textContent=t.n}}}})}})}}),"undefined"!=typeof module&&null!==module?module.exports=u:"undefined"!=typeof window&&null!==window&&(window.xfc=u)}.call(this);
